<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>কর্মীর লেনদেন রিপোর্ট</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            margin-bottom: 20px;
        }
        .form-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .report-master {
            display: none; /* Initially hidden */
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .report-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .report-section {
            margin-bottom: 20px;
        }
        .table th, .table td {
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .total-row {
            font-weight: bold;
            background-color: #e9ecef;
        }
        .error {
            color: #dc3545;
            display: none;
            margin-top: 10px;
        }
        /* PDF Content Styling */
        .pdf-content {
            display: none; /* Hidden by default */
            width: 210mm;
            min-height: 297mm;
            padding: 10mm;
            background-color: #fff;
            box-sizing: border-box;
        }
        .pdf-header {
            text-align: center;
            margin-bottom: 10mm;
        }
        .pdf-tables {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10mm;
        }
        .pdf-income, .pdf-expense {
            width: 48%;
        }
        .pdf-balance {
            width: 100%;
        }
        .pdf-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12pt;
        }
        .pdf-content th, .pdf-content td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        .pdf-content th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .pdf-content .total-row td {
            background-color: #e9ecef;
            font-weight: bold;
        }
        /* Laptop Screen Layout */
        @media (min-width: 992px) {
            .report-sections {
                display: flex;
                justify-content: space-between;
                flex-wrap: wrap;
            }
            .income-section, .expense-section {
                width: 45%;
            }
            .balance-section {
                width: 90%;
                margin-left: auto;
                margin-right: auto;
            }
        }
        /* Mobile Screen Layout */
        @media (max-width: 991px) {
            .income-section, .expense-section, .balance-section {
                width: 95%;
                margin-left: auto;
                margin-right: auto;
            }
        }
        @media (max-width: 768px) {
            .table th, .table td {
                font-size: 0.75rem;
            }
            .form-control, .btn {
                font-size: 0.85rem;
            }
            .navbar-nav .nav-link {
                padding: 0.5rem 1rem;
            }
        }
        @media (max-width: 576px) {
            h2 {
                font-size: 1.5rem;
            }
            .table th, .table td {
                font-size: 0.65rem;
            }
            .report-header h3 {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">জনসেবা কো-অপারেটিভ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
         																							 <li class="nav-item"><a class="nav-link" href="index.html">ড্যাশবোর্ড</a></li>
                    <li class="nav-item"><a class="nav-link" href="members.html">সদস্য তালিকা</a></li>
                    <li class="nav-item"><a class="nav-link" href="ledger.html">লেজার দেখুন</a></li>
                    <li class="nav-item"><a class="nav-link" href="receipt.html">রশিদ দেখুন</a></li>
          																								<li class="nav-item"><a class="nav-link" href="dpsFixedDepositLedger.html">ডিপিএস ও স্থায়ী আমানত লেজার</a></li>
                    <li class="nav-item"><a class="nav-link" href="payable.html">পরিশোধযোগ্য পরিমাণ হিসাব করুন</a></li>
                    <li class="nav-item"><a class="nav-link" href="externalIncomeExpenses.html">বাহ্যিক আয়-ব্যয় দেখুন</a></li>
                    <li class="nav-item"><a class="nav-link" href="reportGenerator.html">রিপোর্ট তৈরি করুন</a></li>
                    <li class="nav-item active"><a class="nav-link active" href="employeeCollectionReport.html">কর্মীর লেনদেন রিপোর্ট দেখুন</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2 class="text-center mb-4">কর্মীর লেনদেন রিপোর্ট</h2>
        <div class="form-container">
            <div class="mb-3">
                <label for="startDate" class="form-label">কোন তারিখ থেকে শুরু করে সর্বমোট লেনদেন দেখতে চান</label>
                <input type="datetime-local" id="startDate" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="endDate" class="form-label">কোন তারিখ পর্যন্ত সর্বমোট লেনদেন দেখতে চান</label>
                <input type="datetime-local" id="endDate" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="employeeName" class="form-label">কোন কর্মীর সর্বমোট লেনদেন দেখতে চান</label>
                <input type="text" id="employeeName" class="form-control" list="employeeList" placeholder="Select an employee" required>
                <datalist id="employeeList"></datalist>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="generateReport()">Fetch</button>
                <button class="btn btn-success" id="generatePDFButton" onclick="generatePDF()" disabled>Generate PDF</button>
            </div>
            <p id="errorMessage" class="error"></p>
        </div>

        <div class="report-master">
            <div class="report-header">
                <h3 id="reportTitle">Report of<br>Transactions</h3>
            </div>
            <div class="report-sections">
                <div class="report-section income-section">
                    <h3 class="mb-3">আয়ের তালিকা</h3>
                    <div class="table-responsive">
                        <table id="incomeTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>আয়ের ধরণ</th>
                                    <th>সর্বমোট পরিমাণ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="report-section expense-section">
                    <h3 class="mb-3">ব্যয়ের তালিকা</h3>
                    <div class="table-responsive">
                        <table id="expenseTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>ব্যয়ের ধরণ</th>
                                    <th>সর্বমোট পরিমাণ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="report-section balance-section">
                    <h3 class="mb-3">ম্যানেজারকে জমা দেওয়ার পরিমাণ</h3>
                    <div class="table-responsive">
                        <table id="balanceTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>বিবরণ</th>
                                    <th>পরিমাণ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden PDF Content -->
        <div class="pdf-content" id="pdfContent">
            <div class="pdf-header">
                <h3 id="pdfReportTitle">Report Of<br>Transactions</h3>
            </div>
            <div class="pdf-tables">
                <div class="pdf-income">
                    <h4>আয়ের তালিকা</h4>
                    <table id="pdfIncomeTable">
                        <thead>
                            <tr>
                                <th>আয়ের ধরণ</th>
                                <th>সর্বমোট পরিমাণ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="pdf-expense">
                    <h4>ব্যয়ের তালিকা</h4>
                    <table id="pdfExpenseTable">
                        <thead>
                            <tr>
                                <th>ব্যয়ের ধরণ</th>
                                <th>সর্বমোট পরিমাণ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="pdf-balance">
                <h4>ম্যানেজারকে জমা দেওয়ার পরিমাণ</h4>
                <table id="pdfBalanceTable">
                    <thead>
                        <tr>
                            <th>বিবরণ</th>
                            <th>পরিমাণ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
									<div id="incomeList"></div>
    <div id="expenseList"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="api.js"></script>
    <script>
        const { jsPDF } = window.jspdf;
        let employeeNames = [];

        // Fetch employee names and populate datalist
        async function fetchEmployeeNames() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getEmployeeNames`);
                const data = await response.json();
                if (data.status === 'success') {
                    employeeNames = data.data;
                    const employeeList = document.getElementById('employeeList');
                    employeeNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        employeeList.appendChild(option);
                    });
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Error fetching employee names:', error);
            }
        }

        // Fetch receipts and generate report for selected employee
        async function generateReport() {
            const errorMessage = document.getElementById('errorMessage');
            const reportMaster = document.querySelector('.report-master');
            const reportTitle = document.getElementById('reportTitle');
            const pdfReportTitle = document.getElementById('pdfReportTitle');
            const generatePDFButton = document.getElementById('generatePDFButton');
            errorMessage.style.display = 'none';
            reportMaster.style.display = 'none';
            generatePDFButton.disabled = true;

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const employeeName = document.getElementById('employeeName').value;

            if (!startDate || !endDate || !employeeName) {
                errorMessage.textContent = 'Please select start date, end date, and employee';
                errorMessage.style.display = 'block';
                return;
            }

            try {
                // Update report headers
                const start = new Date(startDate);
                const end = new Date(endDate);
                const titleText = `Report of : ${employeeName}<br>from<br>${start.toLocaleString()} — ${end.toLocaleString()}`;
                reportTitle.innerHTML = titleText;
                pdfReportTitle.innerHTML = titleText;

                // Fetch all receipts
                const response = await fetch(`${SCRIPT_URL}?action=getReceipts&startDate=2000-01-01&endDate=${endDate}`);
                const data = await response.json();
                if (data.status !== 'success') {
                    throw new Error(data.message);
                }

                const receipts = data.data;

                // Initialize income and expense aggregations for selected employee
                const incomeByType = {};
                const expenseByType = {};
                let priorIncome = 0;
                let priorExpense = 0;

                // Process receipts for the selected employee
                receipts.forEach(receipt => {
                    const receiptDate = new Date(receipt.dateTime);
                    const isIncome = receipt.collectorName === employeeName;
                    const isExpense = receipt.payerName === employeeName;
                    const transactionDetails = receipt.transactionDetails || [];

                    transactionDetails.forEach(detail => {
                        const type = detail.type || 'Unknown';
                        const amount = parseFloat(detail.amount) || 0;

                        if (receiptDate < start) {
                            if (isIncome) priorIncome += amount;
                            if (isExpense) priorExpense += amount;
                        } else if (receiptDate >= start && receiptDate <= end) {
                            if (isIncome) {
                                incomeByType[type] = (incomeByType[type] || 0) + amount;
                            }
                            if (isExpense) {
                                expenseByType[type] = (expenseByType[type] || 0) + amount;
                            }
                        }
                    });
                });

                // Populate income table
                const incomeTableBody = document.querySelector('#incomeTable tbody');
                const pdfIncomeTableBody = document.querySelector('#pdfIncomeTable tbody');
                incomeTableBody.innerHTML = '';
                pdfIncomeTableBody.innerHTML = '';
                let totalIncome = 0;
                for (const [type, amount] of Object.entries(incomeByType)) {
                    const rowHTML = `<td>${type}</td><td>${amount.toFixed(2)}</td>`;
                    const row = document.createElement('tr');
                    row.innerHTML = rowHTML;
                    incomeTableBody.appendChild(row);
                    const pdfRow = document.createElement('tr');
                    pdfRow.innerHTML = rowHTML;
                    pdfIncomeTableBody.appendChild(pdfRow);
                    totalIncome += amount;
                }
                if (Object.keys(incomeByType).length > 0) {
                    const incomeTotalRow = document.createElement('tr');
                    incomeTotalRow.className = 'total-row';
                    incomeTotalRow.innerHTML = `<td>Total Income</td><td>${totalIncome.toFixed(2)}</td>`;
                    incomeTableBody.appendChild(incomeTotalRow);
                    const pdfIncomeTotalRow = document.createElement('tr');
                    pdfIncomeTotalRow.className = 'total-row';
                    pdfIncomeTotalRow.innerHTML = `<td>Total Income</td><td>${totalIncome.toFixed(2)}</td>`;
                    pdfIncomeTableBody.appendChild(pdfIncomeTotalRow);
                } else {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="2">No Income Data</td>`;
                    incomeTableBody.appendChild(noDataRow);
                    const pdfNoDataRow = document.createElement('tr');
                    pdfNoDataRow.innerHTML = `<td colspan="2">No Income Data</td>`;
                    pdfIncomeTableBody.appendChild(pdfNoDataRow);
                }

                // Populate expense table
                const expenseTableBody = document.querySelector('#expenseTable tbody');
                const pdfExpenseTableBody = document.querySelector('#pdfExpenseTable tbody');
                expenseTableBody.innerHTML = '';
                pdfExpenseTableBody.innerHTML = '';
                let totalExpense = 0;
                for (const [type, amount] of Object.entries(expenseByType)) {
                    const rowHTML = `<td>${type}</td><td>${amount.toFixed(2)}</td>`;
                    const row = document.createElement('tr');
                    row.innerHTML = rowHTML;
                    expenseTableBody.appendChild(row);
                    const pdfRow = document.createElement('tr');
                    pdfRow.innerHTML = rowHTML;
                    pdfExpenseTableBody.appendChild(pdfRow);
                    totalExpense += amount;
                }
                if (Object.keys(expenseByType).length > 0) {
                    const expenseTotalRow = document.createElement('tr');
                    expenseTotalRow.className = 'total-row';
                    expenseTotalRow.innerHTML = `<td>Total Expense</td><td>${totalExpense.toFixed(2)}</td>`;
                    expenseTableBody.appendChild(expenseTotalRow);
                    const pdfExpenseTotalRow = document.createElement('tr');
                    pdfExpenseTotalRow.className = 'total-row';
                    pdfExpenseTotalRow.innerHTML = `<td>Total Expense</td><td>${totalExpense.toFixed(2)}</td>`;
                    pdfExpenseTableBody.appendChild(pdfExpenseTotalRow);
                } else {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="2">No Expense Data</td>`;
                    expenseTableBody.appendChild(noDataRow);
                    const pdfNoDataRow = document.createElement('tr');
                    pdfNoDataRow.innerHTML = `<td colspan="2">No Expense Data</td>`;
                    pdfExpenseTableBody.appendChild(pdfNoDataRow);
                }

                // Populate cash balance table
                const priorBalance = priorIncome - priorExpense;
                const currentBalance = totalIncome - totalExpense;
                const balanceTableBody = document.querySelector('#balanceTable tbody');
                const pdfBalanceTableBody = document.querySelector('#pdfBalanceTable tbody');
                const balanceHTML = `
                    <tr><td>সর্বমোট আয় (${start.toLocaleString()} — ${end.toLocaleString()})</td><td>${totalIncome.toFixed(2)}</td></tr>
                    <tr><td>সর্বমোট ব্যয় (${start.toLocaleString()} — ${end.toLocaleString()})</td><td>${totalExpense.toFixed(2)}</td></tr>
                    <tr class="total-row"><td>জমা দিবে(After: ${end.toLocaleString()})</td><td>${currentBalance.toFixed(2)}</td></tr>
                							 <tr><td>আগে সর্বমোট জমা দিয়েছে (Before: ${start.toLocaleString()})</td><td>${priorBalance.toFixed(2)}</td></tr>
                    <tr class="total-row"><td>সর্বমোট জমা হবে(After: ${end.toLocaleString()})</td><td>${(currentBalance+priorBalance).toFixed(2)}</td></tr>
                `;
                balanceTableBody.innerHTML = balanceHTML;
                pdfBalanceTableBody.innerHTML = balanceHTML;

                // Show report and enable PDF button
                reportMaster.style.display = 'block';
                generatePDFButton.disabled = false;
            } catch (error) {
                errorMessage.textContent = 'Failed to generate report: ' + error.message;
                errorMessage.style.display = 'block';
            }
        }

        // Generate PDF
        async function generatePDF() {
            const pdfContent = document.getElementById('pdfContent');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const employeeName = document.getElementById('employeeName').value;
            const start = new Date(startDate);
            const end = new Date(endDate);

            // Sanitize date and employee for filename
            const startStr = start.toLocaleString().replace(/[,:\s]/g, '_');
            const endStr = end.toLocaleString().replace(/[,:\s]/g, '_');
            const employeeStr = employeeName.replace(/[,:\s]/g, '_');
            const fileName = `Transaction_Report_${startStr}_by_${employeeStr}_to_${endStr}.pdf`;

            try {
                // Temporarily show pdfContent for rendering
                pdfContent.style.display = 'block';
                const canvas = await html2canvas(pdfContent, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: true,
                    width: pdfContent.scrollWidth,
                    height: pdfContent.scrollHeight
                });
                console.log('Canvas created:', canvas);

                // Add delay to ensure rendering
                await new Promise(resolve => setTimeout(resolve, 500));

                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Save the PDF with dynamic filename
                pdf.save(fileName);

                // Hide pdfContent after rendering
                pdfContent.style.display = 'none';
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF: ' + error.message);
                pdfContent.style.display = 'none';
            }
        }

        // Load employee names on page load
        fetchEmployeeNames();
    </script>
</body>
</html>